<div class="container my-1">

  <h4 class="fw-bold text-center mb-3 pt-4">Request Details</h4>

  <div class="p-3 rounded mb-3" style="background:#FFF1F2;">

    <div class="card shadow-sm p-3 mb-3">

      <div class="show-grid-row">

        <div class="show-icon bg-light">
          <i class="bi bi-person fs-2 text-secondary"></i>
        </div>

        <div>
          <h6 class="fw-bold mb-1">Patient #<%= @blood_request.id %></h6>
          <small class="text-muted">
            Requesting <strong><%= @blood_request.blood_type %></strong> blood
          </small>
        </div>

        <div class="show-icon text-white"
             style="background:#EC1B35; grid-column: 3 / 4;">
          <strong><%= @blood_request.blood_type %></strong>
        </div>

      </div>

    </div>

    <div class="card shadow-sm p-3 mb-3">

      <div class="row text-center g-3">

        <div class="col-4">
          <div class="show-icon bg-secondary text-white mx-auto mb-1">
            <i class="bi bi-clipboard-check fs-5"></i>
          </div>
          <p class="text-muted small mb-0">Status</p>
          <p class="fw-bold small mb-0"><%= @blood_request.status.humanize %></p>
        </div>

        <div class="col-4">
          <div class="show-icon bg-danger text-white mx-auto mb-1">
            <i class="bi bi-droplet-half fs-5"></i>
          </div>
          <p class="text-muted small mb-0">Quantity</p>
          <p class="fw-bold small mb-0"><%= @blood_request.quantity %> bags</p>
        </div>

        <div class="col-4">
          <div class="show-icon bg-warning text-white mx-auto mb-1">
            <i class="bi bi-clock fs-5"></i>
          </div>
          <p class="text-muted small mb-0">Needed By</p>
          <p class="fw-bold small mb-0"><%= @blood_request.needed_by %></p>
        </div>

      </div>

    </div>

    <% urgency_color =
          case @blood_request.urgency
          when "critical" then "#EC1B35"
          when "urgent"   then "#FFA500"
          else "#0D6EFD"
          end %>

    <div class="card p-3 mb-2">

      <div class="show-grid-row mb-3">
        <div class="show-icon text-white" style="background:<%= urgency_color %>;">
          !
        </div>
        <div>
          <p class="fw-bold mb-0" style="color:<%= urgency_color %>;">
            Urgency: <%= @blood_request.urgency.humanize %>
          </p>
        </div>
      </div>

      <div class="show-grid-row mb-3">
        <div class="show-icon bg-primary text-white">
          <i class="bi bi-geo-alt fs-5"></i>
        </div>
        <div class="small">
          <p class="fw-bold mb-1">Location</p>
          <p class="text-muted mb-0">
            <%= @blood_request.facility&.name %><br>
            <%= @blood_request.facility&.address %>
          </p>
        </div>
      </div>

      <div class="show-grid-row">
        <div class="show-icon bg-success text-white">
          <i class="bi bi-file-text fs-5"></i>
        </div>
        <div class="small">
          <p class="fw-bold mb-1">Patient Note</p>
          <p class="text-muted mb-0">
            <%= @blood_request.message.presence || "No additional information." %>
          </p>
        </div>
      </div>

    </div>

  </div>

  <% if current_user.is_donor? %>
    <% if @blood_request.pending? %>
      <%= button_to "Accept Request",
          accept_blood_request_path(@blood_request),
          method: :patch,
          class: "btn btn-outline-danger btn-sm w-100 mb-2",
          style: "border-radius: 10px;" %>
    <% end %>

    <% if @blood_request.accepted? && @blood_request.accepted_by == current_user %>
      <%= button_to "Mark as Completed",
          complete_blood_request_path(@blood_request),
          method: :patch,
          class: "btn btn-outline-danger btn-sm w-100 mb-2",
          style: "border-radius: 10px;" %>
    <% end %>
  <% end %>

  <% if current_user == @blood_request.user %>
    <% if @blood_request.pending? || @blood_request.accepted? %>
      <%= button_to "Mark as Completed",
          complete_blood_request_path(@blood_request),
          method: :patch,
          class: "btn btn-outline-danger btn-sm w-100 mb-2",
          style: "border-radius: 10px;" %>
    <% end %>
  <% end %>

  <h6 class="fw-bold mt-3 mb-2">Chat with Patient</h6>

  <%= turbo_stream_from "thread_Booking_#{@blood_request.id}_messages" %>

  <div id="messages"
       class="p-2 rounded bg-light mb-2"
       style="height: 200px; overflow-y: auto;">
    <% @blood_request.messages.each do |message| %>
      <%= render "messages/message", message: message %>
    <% end %>
  </div>

  <div class="message-form mt-2">
    <%= simple_form_for [@blood_request, @message],
        html: {
          class: "d-flex gap-2 align-items-center",
          data: { controller: "reset-form",
                  action: "turbo:submit-end->reset-form#reset" }
        } do |f| %>

      <%= f.input :body,
          label: false,
          placeholder: "Type your message...",
          wrapper_html: { class: "flex-grow-1" } %>

      <button class="btn btn-outline-danger btn-sm"
              style="width:50px; height:50px; border-radius: 10px;">
        <i class="bi bi-send fs-5"></i>
      </button>

    <% end %>
  </div>

</div>
